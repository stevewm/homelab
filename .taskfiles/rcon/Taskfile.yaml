# yaml-language-server: $schema=https://taskfile.dev/schema.json
---
version: "3"

tasks:
  vs:
    desc: Connect to Vintage Story rcon
    silent: true
    cmds:
      - task: _rcon
        vars:
          NAME: vintagestory
          NS: games

  mc:
    desc: Connect to Minecraft rcon
    silent: true
    cmds:
      - task: _rcon
        vars:
          NAME: minecraft
          NS: games

  _rcon:
    desc: Open an rcon CLI connection
    preconditions:
      - test -f "${KUBECONFIG}"
      - which rcon kubectl doppler
    internal: true
    interactive: true
    silent: true
    vars:
      RCON_ADDRESS:
        sh: kubectl get svc -n {{ .NS }} -l app.kubernetes.io/name={{ .NAME }} -o jsonpath='{.items[0].status.loadBalancer.ingress[0].ip}'
      RCON_PORT:
        sh: kubectl get svc -n {{ .NS }} -l app.kubernetes.io/name={{ .NAME }} -o jsonpath='{.items[0].spec.ports[?(@.name=="rcon")].port}'
      TYPE: "rcon"
    requires:
      vars:
        - NAME
    dir: "{{ .ROOT_DIR }}"
    cmds:
      - echo "Opening rcon for {{ upper .NAME }} ({{ .RCON_ADDRESS }}:{{ .RCON_PORT }})"
      - rcon --address {{ .RCON_ADDRESS }}:{{ .RCON_PORT }} --password $(doppler secrets get {{ upper .NAME }}_RCON_PASSWORD -p {{ .DOPPLER_PROJECT }} --plain) --type {{ .TYPE }}
